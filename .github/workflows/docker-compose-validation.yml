name: Docker Compose Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  validate-config:
    name: Validate Docker Compose Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: cp .env.example .env

      - name: Validate docker-compose.yml
        run: |
          docker compose config --quiet
          echo "✓ Docker Compose configuration is valid"

      - name: Check configuration output
        run: |
          echo "Generated Docker Compose configuration:"
          docker compose config

  health-check:
    name: Infrastructure Health Check
    runs-on: ubuntu-latest
    needs: validate-config
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: cp .env.example .env

      - name: Start infrastructure stack
        run: |
          docker compose up -d
          echo "Waiting for services to start..."
          sleep 30

      - name: Check service health
        run: |
          docker compose ps
          
          # Check if all services are running
          RUNNING=$(docker compose ps --services --filter "status=running" | wc -l)
          EXPECTED=4
          
          if [ "$RUNNING" -ne "$EXPECTED" ]; then
            echo "❌ Expected $EXPECTED services running, but found $RUNNING"
            docker compose logs
            exit 1
          fi
          
          echo "✓ All $RUNNING services are running"

      - name: Health check - PostgreSQL
        run: |
          docker compose exec -T postgres pg_isready -U platform_user -d 5g_health_platform
          echo "✓ PostgreSQL is ready"

      - name: Health check - Redis
        run: |
          docker compose exec -T redis redis-cli ping
          echo "✓ Redis is ready"

      - name: Health check - NATS
        run: |
          curl -f http://localhost:8222/healthz || exit 1
          echo "✓ NATS is ready"

      - name: Health check - Mosquitto
        run: |
          docker compose exec -T mosquitto mosquitto_sub -t '$SYS/#' -C 1 -i healthcheck -W 3
          echo "✓ Mosquitto is ready"

      - name: Verify TimescaleDB extension
        run: |
          docker compose exec -T postgres psql -U platform_user -d 5g_health_platform -c "SELECT extname FROM pg_extension WHERE extname = 'timescaledb';" | grep timescaledb
          echo "✓ TimescaleDB extension is installed"

      - name: Show service logs on failure
        if: failure()
        run: docker compose logs

      - name: Cleanup
        if: always()
        run: docker compose down -v
